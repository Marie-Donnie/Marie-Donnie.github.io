<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2021-12-17 ven. 09:02 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Operate Resources in Public and Private Clouds Thanks to OpenStack</title>
<meta name="generator" content="Org mode">
<meta name="author" content="Ronan-Alexandre Cherrueau, Adrien Lebre, Marie Delavergne, Didier Iscovery">
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="../../../assets/css/org.css" />
<style>#table-of-contents .tag {display: none;}</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2019 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<header>
<h1 class="title">Operate Resources in Public and Private Clouds Thanks to OpenStack</h1>
</header><div class="abstract">
<p>
OpenStack has become the de-facto solution to operate compute, network
and storage resources in public and private clouds. In this lab, we
are going to:
</p>
<ul class="org-ul">
<li>Deploy an all-in-one OpenStack with <a href="https://opendev.org/x/microstack/">Snap microstack</a>.</li>
<li>Operate this OpenStack to manage IaaS resources (e.g., boot VMs,
setup a private Network).</li>
<li>Deploys a Wordpress as a Service.</li>
<li>Automatize all the stuff with the Heat template engine (i.e., manage
your cloud from your sofa!).</li>
</ul>

<p>
Find the slides of the lecture <a href="https://github.com/BeyondTheClouds/lectures/blob/34c031d/2018-2019/os-polytech/docs/CloudFogEdgeIntro.pdf?raw=true">here</a> and <a href="https://github.com/BeyondTheClouds/lectures/blob/34c031d/2018-2019/os-polytech/docs/openstack-slides.pdf?raw=true">there</a>.  Find the collaborative
editor to follow lab completion <a href="https://notes.inria.fr/tFihp6A5TA-fOaUIvqNdyw">here</a>.
</p>

</div>

<nav id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec:req">1. Requirements and Setup</a>
<ul>
<li><a href="#orgc118429">1.1. Environment</a></li>
<li><a href="#sec:assign-lab">1.2. Access the Lab machine</a></li>
<li><a href="#sec:rscs-lab">1.3. Resources of the Lab</a></li>
<li><a href="#org5f93fd0">1.4. Setup OpenStack</a></li>
</ul>
</li>
<li><a href="#sec:play-with-os">2. Play with OpenStack (as an Admin)</a>
<ul>
<li><a href="#org0703ea8">2.1. OpenStack Horizon dashboard</a></li>
<li><a href="#sec:os-cli">2.2. Unleash the operator in you</a>
<ul>
<li><a href="#orgf30a6f1">2.2.1. Make the world reaches the VM</a></li>
</ul>
</li>
<li><a href="#sec:enc-trust">2.3. In encryption we trust</a></li>
<li><a href="#org293770a">2.4. The art of contextualizing a VM</a>
<ul>
<li><a href="#sec:debian10-ftw">2.4.1. Debian 10 FTW</a></li>
<li><a href="#sec:cloud-init">2.4.2. <code>cloud-init</code> in Action</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec:wp-devops">3. Deploy a WordPress as a Service (as a DevOps)</a></li>
<li><a href="#org7ec45c3">4. Appendix</a>
<ul>
<li><a href="#orgde0e258">4.1. Vagrantfile</a></li>
<li><a href="#orge2f6211">4.2. Install MariaDB on Debian 10</a></li>
<li><a href="#org64633b9">4.3. Install Wordpress application on Debian 10</a></li>
<li><a href="#org1d4c167">4.4. VM Live migration</a></li>
</ul>
</li>
</ul>
</div>
</nav>

<div id="outline-container-orge873912" class="outline-2">
<h2 id="sec:req"><a id="orge873912"></a><span class="section-number-2">1</span> Requirements and Setup</h2>
<div class="outline-text-2" id="text-sec:req">
</div>
<div id="outline-container-orgc118429" class="outline-3">
<h3 id="orgc118429"><span class="section-number-3">1.1</span> Environment</h3>
<div class="outline-text-3" id="text-1-1">
<p>
To follow the lab you&rsquo;ll need a Linux (tested under Ubuntu 20.04)
with, at least, 8 GiB of RAM and 2 CPU.  We are going to use Linux
Dell R320 from room D011.  If you have a <b>different version</b> of Ubuntu
installed &#x2013; use <code>lsb_release -d</code> to check it out &#x2013; you should start
a proper VM using, for instance, the <a href="#orgde0e258">Vagrantfile</a> given in the
Appendix.  Alternatively, you can also use your own machine.
</p>

<p>
The lab makes use of <a href="https://github.com/CanonicalLtd/microstack">Snap microstack</a>: OpenStack in a Snap that you can
run locally on a single machine. Snap is the Canonical&rsquo;s App delivery
mechanism. It enables developers to bundle all dependencies into a
single app package. And so does Snap microstack for an all-in-one
OpenStack on your machine.
</p>

<p>
An all-in-one OpenStack means that your machine will contain both
services to <i>operate</i> and <i>host</i> virtualized resources. For instance,
the <code>nova-conductor</code> to operate the boot of a VM, and <code>nova-compute</code>
to host the VM. This is a good setup for a lab, but not for
production. There are several other options such as <a href="https://docs.openstack.org/devstack/latest/index.html">DevStack</a>,
<a href="https://docs.openstack.org/puppet-openstack-guide/latest/">Puppet-OpenStack</a> or <a href="https://docs.openstack.org/developer/kolla-ansible/">Kolla-ansible</a> and all matters. But, Snap
microstack takes only 2 minutes to deploy OpenStack (instead of 30
minutes for other options).
</p>

<div class="note">
<ul class="org-ul">
<li>Devstack is good for OpenStack developers.</li>
<li>Puppet-OpenStack or Kolla-ansible are good for production
deployments.</li>
</ul>

</div>
</div>
</div>

<div id="outline-container-org5772e93" class="outline-3">
<h3 id="sec:assign-lab"><a id="org5772e93"></a><span class="section-number-3">1.2</span> Access the Lab machine</h3>
<div class="outline-text-3" id="text-sec:assign-lab">
<p>
First thing first, you have to connect to the Lab machine as <code>invit√©</code>
and create your account.
</p>

<p>
Lab machines aren&rsquo;t available publicly unfortunately.  They are hidden
behind Polytech private network.  Fortunately, a frontend is available
from the outside world at the address <code>163.172.58.84</code> that let us
reach Lab machines.  SSH on that frontend using the login and
password given in the pad of the collaborative editor and then, SSH on
your Lab machine.  Password for <code>invit√©</code> on the lab machine is <code>d012</code>.
</p>

<div class="org-src-container">
<pre class="src src-bash">ssh -l &lt;login&gt; 163.172.58.84
ssh -l invit&#233; 192.52.86.XXX
</pre>
</div>

<p>
From there, create your account on the Lab machine (use a valid
univ-nantes email address).
</p>
<pre class="example">
sudo useradd -g 100 -G adm,sudo -m -s /bin/bash -c \
  '&lt;Pr√©nom&gt; &lt;Nom&gt; &lt;pr√©nom.nom@etu.univ-nantes.fr&gt;' &lt;login&gt;
sudo passwd &lt;login&gt;

</pre>

<p>
And change user ID from <code>invit√©</code> to your <code>&lt;login&gt;</code>.
</p>
<pre class="example">
su &lt;login&gt;

</pre>

<p>
The rest of this lab <b>proceeds on the Lab machine</b>.
</p>
</div>
</div>

<div id="outline-container-org209c4c2" class="outline-3">
<h3 id="sec:rscs-lab"><a id="org209c4c2"></a><span class="section-number-3">1.3</span> Resources of the Lab</h3>
<div class="outline-text-3" id="text-sec:rscs-lab">
<p>
Get the resources of the lab at <a href="https://github.com/Marie-Donnie/lectures/blob/master/2021-2022/os-polytech/tp.tar.gz">https://github.com/Marie-Donnie/lectures/blob/master/2021-2022/os-polytech/tp.tar.gz</a>.
</p>

<div class="org-src-container">
<pre class="src src-bash">curl https://github.com/Marie-Donnie/lectures/raw/master/2021-2022/os-polytech/tp.tar.gz -o tp.tar.gz -L
tar xzf tp.tar.gz
<span style="color: #f08080;">cd</span> lab-os
</pre>
</div>

<p>
The archive contains:
</p>
<dl class="org-dl">
<dt>setup.sh</dt><dd>Script that sets up the lab.</dd>
<dt>teardown.sh</dt><dd>Script that uninstalls the lab.</dd>
<dt>rsc</dt><dd>Resource directory with bash scripts useful for the lab.</dd>
</dl>
</div>
</div>

<div id="outline-container-org5f93fd0" class="outline-3">
<h3 id="org5f93fd0"><span class="section-number-3">1.4</span> Setup OpenStack</h3>
<div class="outline-text-3" id="text-1-4">
<p>
Install snap.
</p>
<pre class="example">
sudo apt update
sudo apt install snapd

</pre>

<p>
Ensure OpenStack microstack is not already installed and remove it otherwise.
</p>
<pre class="example">
snap info microstack | fgrep -q installed &amp;&amp; sudo snap remove --purge microstack

</pre>

<p>
Install the last version from the snap store.
</p>
<pre class="example">
sudo snap install --channel=latest/beta microstack --devmode

</pre>

<p>
Execute the <code>setup.sh</code> file with sudo to initialize OpenStack (setup
networks, flavors, images, &#x2026;).
</p>
<pre class="example">
sudo ./setup.sh

</pre>

<div class="do">
<p>
Then, ensure OpenStack services are running on your machine. Find the
snap command that lists microstack OpenStack services and there
status? What is the purpose of each service?
</p>

</div>
</div>
</div>
</div>

<div id="outline-container-org9d2ecb3" class="outline-2">
<h2 id="sec:play-with-os"><a id="org9d2ecb3"></a><span class="section-number-2">2</span> Play with OpenStack (as an Admin)</h2>
<div class="outline-text-2" id="text-sec:play-with-os">
</div>
<div id="outline-container-org0703ea8" class="outline-3">
<h3 id="org0703ea8"><span class="section-number-3">2.1</span> OpenStack Horizon dashboard</h3>
<div class="outline-text-3" id="text-2-1">
<p>
One service deployed is the OpenStack dashboard (Horizon). On your own
machine, horizon is reachable from the web browser at
<a href="https://&lt;ip-of-your-lab-machine&gt;">https://&lt;ip-of-your-lab-machine&gt;</a> with the following credentials:
</p>
<ul class="org-ul">
<li>login: <code>admin</code></li>
<li>password: <code>keystone</code></li>
</ul>

<p>
From here, you can reach <code>Project &gt; Compute &gt; Instances &gt; Launch
Instance</code> and boot a virtual machine given the following information:
</p>
<ul class="org-ul">
<li>a name (e.g., <code>horizon-vm</code>)</li>
<li>an image (e.g., <code>cirros</code>) and set the <code>Create New Volume</code> to &ldquo;No&rdquo;</li>
<li>a flavor to limit the resources of your instance (we recommend
<code>m1.tiny</code>)</li>
<li>and a network setting (must be <code>test</code>)</li>
</ul>

<p>
You should select options by clicking on the big arrow on the right of
each possibility. When the configuration is OK, the <code>Launch Instance</code>
button should be enabled. After clicking on it, you should see the
instance in the <code>Active</code> state in less than a minute.
</p>

<p>
Now, you have several options to connect to your freshly deployed VM.
For instance, after clicking on its name, Horizon provides a virtual
console under the <code>Console</code> tab. So, you can use the following
credentials to access the VM:
</p>
<ul class="org-ul">
<li>login: <code>cirros</code></li>
<li>password: <code>gocubsgo</code></li>
</ul>

<p>
However, as a <i>real DevOps</i>, you will prefer to access to your VM by
the command line interface &hellip;
</p>
</div>
</div>

<div id="outline-container-orgfd6085c" class="outline-3">
<h3 id="sec:os-cli"><a id="orgfd6085c"></a><span class="section-number-3">2.2</span> Unleash the operator in you</h3>
<div class="outline-text-3" id="text-sec:os-cli">
<p>
While Horizon is helpful to discover OpenStack features, this is not
the tool of choice for an operator. An operator prefers command line
interface üòÑ. You are lucky, OpenStack provides one.
</p>

<p>
All operations to manage OpenStack are done through one unique command
line, called <code>openstack &lt;service&gt; &lt;action&gt; ...</code>. Doing an <code>openstack
--help</code> displays the <i>really long</i> list of services/possibilities
provided by this command. The following gives you a selection of the
most often used commands to operate your Cloud:
</p>
<dl class="org-dl">
<dt>List OpenStack running services</dt><dd><code>openstack endpoint list</code></dd>
<dt>List images</dt><dd><code>openstack image list</code></dd>
<dt>List flavors</dt><dd><code>openstack flavor list</code></dd>
<dt>List networks</dt><dd><code>openstack network list</code></dd>
<dt>List computes</dt><dd><code>openstack hypervisor list</code></dd>
<dt>List VMs (running or not)</dt><dd><code>openstack server list</code></dd>
<dt>Get details on a specific VM</dt><dd><code>openstack server show &lt;vm-name&gt;</code></dd>
<dt>Start a new VM</dt><dd><code>openstack server create --image &lt;image-name&gt; --flavor &lt;flavor-name&gt; --network &lt;network-name&gt; &lt;vm-name&gt;</code></dd>
<dt>View VMs logs</dt><dd><code>openstack console log show &lt;vm-name&gt;</code></dd>
</dl>

<div class="do">
<p>
Try one of these commands. Does it works? What is the problem, how to
fix it? Hint: Look at the <a href="https://docs.openstack.org/python-openstackclient/ussuri/cli/authentication.html">password authentication process</a> for the CLI.
Second hint: After you saw how cumbersome it is to add the
credentials to each command, you can find how to source them thanks to
the dashboard (see the <a href="https://docs.openstack.org/liberty/install-guide-obs/keystone-openrc.html">client environment documentation</a>).
</p>

</div>

<div class="do">
<p>
Using all these commands, use the CLI to start a new tiny cirros VM
called <code>cli-vm</code>.
</p>

</div>

<p>
Then, display the information about your VM with the following
command:
</p>
<pre class="example">
openstack server show cli-vm

</pre>

<p>
Note in particular the <code>status</code> of your VM (and how to extract that
information from the command line with the <code>-c</code> and <code>-f</code>).
</p>
<pre class="example">
openstack server show cli-vm -c status -f json

</pre>

<p>
This status will go from <code>BUILD</code>: OpenStack is looking for the best
place to boot the VM; to <code>ACTIVE</code>: your VM is running. The status
could also be <code>ERROR</code> if you are experiencing hard times with your
infrastructure.
</p>

<div class="do">
<p>
What is the purpose of the <code>-c</code> and <code>-f</code> argument in the previous
command.
</p>

</div>

<p>
A VM in <code>ACTIVE</code> state still has to go through the <a href="http://www.tldp.org/LDP/intro-linux/html/sect_04_02.html">boot process and
init</a>. Hence, you may still have to wait for one minute or two that
your VM finishes to boot. You can check that your VM finished to boot
by looking at its logs with <code>openstack console log show cli-vm</code>. A
CirrOS VM finished to boot when last lines are:
</p>
<pre class="example">
=== cirros: current=0.4.0 latest=0.4.0 uptime=29.16 ===
  ____               ____  ____
 / __/ __ ____ ____ / __ \/ __/
/ /__ / // __// __// /_/ /\ \
\___//_//_/  /_/   \____/___/
   http://cirros-cloud.net


login as 'cirros' user. default password: 'gocubsgo'. use 'sudo' for root.
cli-vm login:
</pre>
</div>

<div id="outline-container-orgf30a6f1" class="outline-4">
<h4 id="orgf30a6f1"><span class="section-number-4">2.2.1</span> Make the world reaches the VM</h4>
<div class="outline-text-4" id="text-2-2-1">
<p>
The <a href="https://docs.openstack.org/neutron/ussuri/">neutron</a> service manage networks in OpenStack.  Neutron
distinguishes, at least two kind of networks.  First, the <i>project (or
tenant) network</i> to provide communication between VMs of the same
project.  Second, the <i>provider (or external) network</i> to provide an
access to the VM from the outside.  With the
previous <code>openstack server create</code> command, the VM boots with an IP on
the tenant network.  Consequently, you cannot ping your VM from an
external network (e.g., the Lab machine).
</p>

<div class="do">
<p>
Find the IP address of the <code>cli-vm</code>. Check that you can ping that
address from the <code>horizon-vm</code> (using the <code>Console</code> tab in the Horizon
dashboard).  Ensure that you <b>cannot</b> ping that VM from the Lab machine.
</p>

</div>

<p>
To ping your VM from the Lab machine, you have to affect it an IP
address of the <code>external</code> network.  The management of the external
network is typically done at the level of the infrastructure and not
by OpenStack.  OpenStack allows to access IP addresses of that network
using <i>floating IPs</i>.  A floating IP is not allocated to a specific VM
by default.  Rather, an operator has to explicitly <i>pick</i> one from a
pool and then attach it to its VM.  Thus, if the VM dies for some
reason, the operator does not lose the floating IP &#x2013; it remains her
own resource, ready to be attached to another VM.  For instance, OVH
uses that mechanism to assign public IP addresses to VMs.
</p>

<p>
Affect a floating IP of the <code>external</code> network to your machine if you
want it to be pingable from the host.
</p>
<div class="org-src-container">
<pre class="src src-bash"><span style="color: #4eee94;">ALLOCATED_FIP</span>=$(<span style="color: #fa8072;">openstack</span> floating ip create <span style="color: #deb887;">\</span>
  -c floating_ip_address -f value external)
<span style="color: #f08080;">echo</span> <span style="color: #deb887;">"${ALLOCATED_FIP}"</span>
openstack server add floating ip cli-vm <span style="color: #deb887;">"${ALLOCATED_FIP}"</span>
</pre>
</div>

<p>
Then, ask again for the status of your VM and its IPs.
</p>
<pre class="example">
openstack server show cli-vm -c status -c addresses

</pre>

<div class="do">
<p>
Ping <code>cli-vm</code> on its floating IP.
</p>
<pre class="example">
ping -c 3 "$ALLOCATED_FIP"

</pre>

<p>
Does it work? Why? Hint: OpenStack limits the incomming traffic by
default for security reasons.  The mechanisms to control the traffic
in OpenStack is called <a href="https://docs.openstack.org/neutron/ussuri/feature_classification/general_feature_support_matrix.html#operation_Security_Groups">security group</a>.  Find the command that list the
security group rules of the <code>admin</code> project. # (i.e., <code>openstack
project show admin</code>).
</p>

<p>
Then, make it work for <code>10.20.20.0/24</code> network. See examples of
security groups rules in the <a href="https://docs.openstack.org/neutron/latest/admin/deploy-lb-selfservice.html#verify-network-operation">neutron doc</a>.
</p>

</div>

<p>
Once you succeed to ping the vm, you should also be able to SSH on it.
</p>
<pre class="example">
ssh -l cirros "$ALLOCATED_FIP"

</pre>

<div class="do">
<p>
Go on, and play with the <code>openstack</code> CLI.  List all features offered
by Nova with <code>openstack server --help</code> and figure out how to:
</p>
<ol class="org-ol">
<li>SSH on <code>cli-vm</code> using its name rather than its IP;</li>
<li>Pause it, note the footprint on the ram of the hypervisor, and unpause it;</li>
<li><del>Suspend it, note the footprint on the ram of the hypervisor, and
resume it;</del> Does not work right now, do not try it if you do not want to have to re-create it üòí</li>
<li>Create a snapshot of <code>cli-vm</code>;</li>
<li>Boot a new machine <code>cli-vm-clone</code> from the snapshot;</li>
<li>Delete <code>cli-vm-clone</code>;</li>
</ol>

</div>
</div>
</div>
</div>

<div id="outline-container-orgb6b6201" class="outline-3">
<h3 id="sec:enc-trust"><a id="orgb6b6201"></a><span class="section-number-3">2.3</span> In encryption we trust</h3>
<div class="outline-text-3" id="text-sec:enc-trust">
<p>
Any cirros VMs share the same credentials (i.e., <code>cirros</code>, <code>gocubsgo</code>)
which is a security problem. As a IaaS DevOps, you want that only some
clients can SSH on the VMs. Fortunately, OpenStack helps with the
management of SSH keys. OpenStack can generate a SSH key and push the
public counterpart on the VM. Therefore, doing a <code>ssh</code> on the VM will
use the SSH key instead of asking the client to fill the credentials.
</p>

<p>
Make an SSH key and store the private counterpart in <code>./admin.pem</code>.
Then, give that file the correct permission access.
</p>
<pre class="example">
openstack keypair create --private-key ./admin.pem admin
chmod 600 ./admin.pem

</pre>

<p>
Start a new VM and ask OpenStack to copy the public counterpart of
your SSH key in the <code>~/.ssh/authorized_keys</code> of the VM (i.e., note the
<code>--key-name admin</code>).
</p>
<div class="org-src-container">
<pre class="src src-bash">openstack server create --wait --image cirros <span style="color: #deb887;">\</span>
  --flavor m1.tiny --network test <span style="color: #deb887;">\</span>
  --key-name admin cli-vm-adminkey
</pre>
</div>

<p>
Attach it a floating IP.
</p>
<div class="org-src-container">
<pre class="src src-bash">openstack server add floating ip <span style="color: #deb887;">\</span>
  cli-vm-adminkey <span style="color: #deb887;">\</span>
  $(<span style="color: #fa8072;">openstack</span> floating ip create -c floating_ip_address -f value external)
</pre>
</div>

<p>
Now you can access your VM using SSH without filling credentials.
</p>
<div class="org-src-container">
<pre class="src src-bash">openstack server ssh cli-vm-adminkey <span style="color: #deb887;">\</span>
  --login cirros <span style="color: #deb887;">\</span>
  --identity ./admin.pem
</pre>
</div>

<div class="note">
<p>
Or directly with the <code>ssh</code> command &#x2014; for bash lovers ‚ù§.
</p>
<pre class="example">
ssh -i ./admin.pem -l cirros $(openstack server show cli-vm-adminkey -c addresses -f value | sed  -Er 's/test=.+ (10\.20\.20\.[0-9]+).*/\1/g')

</pre>

<p>
A regular <code>ssh</code> command looks like <code>ssh -i &lt;identity-file&gt; -l &lt;name&gt;
&lt;server-ip&gt;</code>. The OpenStack command followed by the <code>sed</code> returns the
floating IP of <code>cli-vm-adminkey</code>. You may have to adapt it a bit
according to your network cidr.
</p>
<pre class="example">
openstack server show cli-vm-adminkey -c addresses -f value | sed  -Er 's/test=.+ (10\.20\.20\.[0-9]+).*/\1/g'

</pre>

</div>
</div>
</div>

<div id="outline-container-org293770a" class="outline-3">
<h3 id="org293770a"><span class="section-number-3">2.4</span> The art of contextualizing a VM</h3>
<div class="outline-text-3" id="text-2-4">
<p>
Contextualizing is the process that automatically installs software,
alters configurations, and does more on a machine as part of its boot
process. On OpenStack, contextualizing is achieved thanks to
<a href="https://cloud-init.io/"><code>cloud-init</code></a>. It is a program that runs at the boot time to customize
the VM.
</p>

<p>
You have already used <code>cloud-init</code> without even knowing it! The
previous command <code>openstack server create</code> with the <code>--identity</code>
parameter tells OpenStack to make the public counterpart of the SSH
key available to the VM. When the VM boots for the first time,
<code>cloud-init</code> is (among other tasks) in charge of fetching this public
SSH key from OpenStack, and copy it to <code>~/.ssh/authorized_keys</code>.
Beyond that, <code>cloud-init</code> is in charge of many aspects of the VM
customization like mounting volume, resizing file systems or setting
an hostname (the list of <code>cloud-init</code> modules can be found <a href="http://cloudinit.readthedocs.io/en/latest/topics/modules.html">here</a>).
Furthermore, <code>cloud-init</code> is able to run a bash script that will be
executed on the VM as <code>root</code> during the boot process.
</p>
</div>

<div id="outline-container-orgcc96a88" class="outline-4">
<h4 id="sec:debian10-ftw"><a id="orgcc96a88"></a><span class="section-number-4">2.4.1</span> Debian 10 FTW</h4>
<div class="outline-text-4" id="text-sec:debian10-ftw">
<p>
When it comes the time to deal with real applications, we cannot use
cirros VMs anymore. A Cirros VM is good for testing because it starts
fast and has a small memory footprint. However, do not expect to
launch <a href="https://en.wikipedia.org/wiki/MariaDB">MariaDB</a> or even <a href="https://github.com/busyloop/lolcat"><code>lolcat</code></a> on a cirros.
</p>

<p>
We are going to run several Debian10 VMs in this section. But, a
Debian10 takes a lot more of resources to run. For this reason, you may
want to release all your resources before going further.
</p>

<div class="org-src-container">
<pre class="src src-bash" id="orgc28cfad"><span style="color: #7f7f7f;"># </span><span style="color: #7f7f7f;">Delete VMs</span>
<span style="color: #00bfff;">for</span> vm<span style="color: #00bfff;"> in</span> $(<span style="color: #fa8072;">openstack</span> server list -c ID -f value); <span style="color: #00bfff;">do</span> <span style="color: #deb887;">\</span>
  <span style="color: #f08080;">echo</span> <span style="color: #deb887;">"Deleting ${vm}..."</span>; <span style="color: #deb887;">\</span>
  openstack server delete <span style="color: #deb887;">"${vm}"</span>; <span style="color: #deb887;">\</span>
<span style="color: #00bfff;">done</span>

<span style="color: #7f7f7f;"># </span><span style="color: #7f7f7f;">Releasing floating IPs</span>
<span style="color: #00bfff;">for</span> ip<span style="color: #00bfff;"> in</span> $(<span style="color: #fa8072;">openstack</span> floating ip list -c <span style="color: #deb887;">"Floating IP Address"</span> -f value); <span style="color: #00bfff;">do</span> <span style="color: #deb887;">\</span>
  <span style="color: #f08080;">echo</span> <span style="color: #deb887;">"Releasing ${ip}..."</span>; <span style="color: #deb887;">\</span>
  openstack floating ip delete <span style="color: #deb887;">"${ip}"</span>; <span style="color: #deb887;">\</span>
<span style="color: #00bfff;">done</span>
</pre>
</div>

<p>
Then, download the Debian10 image with support of <code>cloud-init</code>.
</p>
<div class="org-src-container">
<pre class="src src-bash">curl -L -o ./debian-10.qcow2 <span style="color: #deb887;">\</span>
  https://cloud.debian.org/images/cloud/OpenStack/current-10/debian-10-openstack-amd64.qcow2
</pre>
</div>

<div class="do">
<p>
Import the image into Glance; name it <code>debian-10</code>. Use <code>openstack image
create --help</code> for creation arguments. Find values example with
<code>openstack image show cirros</code>.
</p>

<p>
And, create a new <code>m1.mini</code> flavor with 5 Go of Disk, 2 Go of RAM, 2
VCPU and 1 Go of swap. Use <code>openstack flavor create --help</code> for
creation arguments.
</p>

</div>
</div>
</div>

<div id="outline-container-org1ed66d6" class="outline-4">
<h4 id="sec:cloud-init"><a id="org1ed66d6"></a><span class="section-number-4">2.4.2</span> <code>cloud-init</code> in Action</h4>
<div class="outline-text-4" id="text-sec:cloud-init">
<p>
To tell <code>cloud-init</code> to load and execute a specific script at boot
time, you should append the <code>--user-data &lt;file/path/of/your/script&gt;</code>
extra argument to the regular <code>openstack server create</code> command.
</p>

<div class="do">
<p>
Start a new VM named <code>art-vm</code> based on the <code>debian-10</code> image and the
<code>m1.mini</code> flavor. The VM should load and execute the script <a href="#org2cd7a6c">1</a>
&#x2013; available under <code>rsc/art.sh</code> &#x2013; that installs the <a href="https://github.com/cmatsuoka/figlet"><code>figlet</code></a> and
<a href="https://github.com/busyloop/lolcat"><code>lolcat</code></a> softwares on the VM.
</p>

</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span><code>cloud-init</code> script available under <code>rsc/art.sh</code></label><pre class="src src-bash" id="org2cd7a6c"><span style="color: #7f7f7f;">#</span><span style="color: #7f7f7f;">!/usr/bin/</span><span style="color: #00bfff;">env</span><span style="color: #7f7f7f;"> bash</span>
<span style="color: #7f7f7f;"># </span><span style="color: #7f7f7f;">Fix DNS resolution</span>
<span style="color: #f08080;">echo</span> <span style="color: #deb887;">""</span> &gt; /etc/resolv.conf
<span style="color: #f08080;">echo</span> <span style="color: #deb887;">"nameserver 8.8.8.8"</span> &gt;&gt; /etc/resolv.conf

<span style="color: #7f7f7f;"># </span><span style="color: #7f7f7f;">Install figlet and lolcat</span>
apt update
apt install -y figlet lolcat
</pre>
</div>

<p>
You can follow the correct installation of software with:
</p>
<pre class="example">
watch openstack console log show --lines=20 art-vm

</pre>

<div class="do">
<p>
Could you notice <i>when</i> the VM has finished to boot based on the
<code>console log</code> output?  Write a small bash script that waits until the
boot has finished.
</p>

</div>

<p>
Then, attach it a floating IP.
</p>
<div class="org-src-container">
<pre class="src src-bash">openstack server add floating ip <span style="color: #deb887;">\</span>
  art-vm <span style="color: #deb887;">\</span>
  $(<span style="color: #fa8072;">openstack</span> floating ip create -c floating_ip_address -f value external)
</pre>
</div>

<p>
Hence, you can jump on the VM and call the <code>figlet</code> and <code>lolcat</code>
software.
</p>
<pre class="example">
$ openstack server ssh art-vm \
    --login debian \
    --identity ./admin.pem

The authenticity of host '10.20.20.13 (10.20.20.13)' can't be established.
ECDSA key fingerprint is SHA256:WgAn+/gWYg9MkauihPyQGwC0LJ8sLWM/ySrUzN8cK9w.
Are you sure you want to continue connecting (yes/no)? yes

debian@art-vm:~$ figlet "The Art of Contextualizing a VM" | lolcat
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org572e618" class="outline-2">
<h2 id="sec:wp-devops"><a id="org572e618"></a><span class="section-number-2">3</span> Deploy a WordPress as a Service (as a DevOps)</h2>
<div class="outline-text-2" id="text-sec:wp-devops">
<p>
In the previous sessions, we saw how to boot a VM with OpenStack, and
execute a post-installation script using the <code>user-data</code> mechanism.
Such mechanism can help us to install software but it is not enough to
deploy a real Cloud application.  Cloud applications are composed of
multiple services that collaborate to deliver the application.  Each
service is in charge of one aspect of the application.  This
separation of concerns brings flexibility.  If a single service is
overloaded, it is common to deploy new units of this service to
balance the load.
</p>

<p>
Let&rsquo;s take a simple example: <a href="https://wordpress.org/">WordPress</a>! WordPress is a very popular
content management system (CMS) in use on the Web.  People use it to
create websites, blogs or applications.  It is open-source, written in
PHP, and composed of two elements: a Web server (Apache) and database
(MariaDB).  Apache serves the PHP code of WordPress and stores its
information in the database.
</p>

<p>
Automation is a very important concept for DevOps.  Imagine you have
your own datacenter and want to exploit it by renting WordPress
instances to your customers.  Each time a client rents an instance,
you have to manually deploy it?!  No. It would be more convenient to
automate all the operations. üòé
</p>

<div class="do">
<p>
As the DevOps of OWPH &#x2013; Online WordPress Hosting &#x2013; your job is to
automatize the deployment of WordPress on your OpenStack.  To do so,
you have to make a bash script that:
</p>

<ol class="org-ol">
<li>Start <code>wordpress-db</code>: a VM that contains the MariaDB database for
WordPress.</li>
<li>Wait until its final deployment (the database is running).</li>
<li>Start <code>wordpress-app</code>: a VM that contains a web server and serves
the Wordpress CMS.</li>
<li>Expose <code>wordpress-app</code> to the world via your Lab machine on a
specific port (because our floating IPs are not real public IPs and
thus inaccessible from the world). Something like
<a href="http://&lt;ip-of-your-lab&gt;:8080">http://&lt;ip-of-your-lab&gt;:8080</a>.</li>
<li>Finally, connect with your browser to the WordPress website (i.e.,
<a href="http://&lt;ip-of-your-lab&gt;:8080/wp">http://&lt;ip-of-your-lab&gt;:8080/wp</a>) and initializes a new WordPress
project named <code>os-owph</code>.</li>
</ol>

<p>
The <code>rsc</code> directory provides bash scripts to deploy the MariaDB
database and web server of WordPress (also in <a href="#org7ec45c3">Appendix</a>). Review it
before going any further (spot the <b>TODO</b>).  And ask yourself
questions such as: Does the <code>wordpress-db</code> VM needs a floating IP in
order to be reached by the <code>wordpress-app</code> VM?
</p>

<p>
Also, remind to <a href="#orgc28cfad">clean your environment</a>.
</p>

</div>
</div>
</div>




<div id="outline-container-org7ec45c3" class="outline-2">
<h2 id="org7ec45c3"><span class="section-number-2">4</span> Appendix</h2>
<div class="outline-text-2" id="text-4">
</div>
<div id="outline-container-orgde0e258" class="outline-3">
<h3 id="orgde0e258"><span class="section-number-3">4.1</span> Vagrantfile</h3>
<div class="outline-text-3" id="text-4-1">
<p>
<a href="https://en.wikipedia.org/wiki/Vagrant_(software)">Vagrant</a> is an open-source software to build development environment
using a declarative approach.  In addition to Vagrant, we recommend to
install the <a href="https://github.com/vagrant-libvirt/vagrant-libvirt#installation">Vagrant Libvirt Provider</a> in order to take advantage of the
hardware virtualization.
</p>

<p>
Copy the following content into a file named &ldquo;Vagrantfile&rdquo;.  Review
the content, especially the number of CPU, memory size and the
private/public network.
</p>
<div class="org-src-container">
<pre class="src src-ruby"><span style="color: #7f7f7f;"># </span><span style="color: #7f7f7f;">-*- mode: ruby -*-</span>
<span style="color: #7f7f7f;"># </span><span style="color: #7f7f7f;">vi: set ft=ruby :</span>

<span style="color: #98f5ff;">Vagrant</span>.configure(<span style="color: #deb887;">"2"</span>) <span style="color: #00bfff;">do</span> |config|
  <span style="color: #7f7f7f;"># </span><span style="color: #7f7f7f;">Ensure that the box is built with VirtIO Network Interface for</span>
  <span style="color: #7f7f7f;"># </span><span style="color: #7f7f7f;">libvirt.  This is not the case of generic/ubuntu2004 which then</span>
  <span style="color: #7f7f7f;"># </span><span style="color: #7f7f7f;">leads to issues with ovn geneve in OpenStack.</span>
  config.vm.box = <span style="color: #deb887;">"peru/ubuntu-20.04-server-amd64"</span>
  <span style="color: #7f7f7f;"># </span><span style="color: #7f7f7f;">config.vm.box = "peru/ubuntu-18.04-server-amd64"</span>
  config.vm.box_version = <span style="color: #deb887;">"20201107.01"</span>
  config.vm.box_check_update = <span style="color: #a2cd5a;">false</span>
  <span style="color: #7f7f7f;"># </span><span style="color: #7f7f7f;">Horizon dashboard</span>
  config.vm.network <span style="color: #a2cd5a;">:forwarded_port</span>, <span style="color: #a2cd5a;">guest:</span> 80, <span style="color: #a2cd5a;">host:</span> 8080, <span style="color: #a2cd5a;">host_ip:</span> <span style="color: #deb887;">"*"</span>
  <span style="color: #7f7f7f;"># </span><span style="color: #7f7f7f;">Horizon Spice Javascript console</span>
  config.vm.network <span style="color: #a2cd5a;">:forwarded_port</span>, <span style="color: #a2cd5a;">guest:</span> 6082, <span style="color: #a2cd5a;">host:</span> 6082, <span style="color: #a2cd5a;">host_ip:</span> <span style="color: #deb887;">"*"</span>
  <span style="color: #7f7f7f;"># </span><span style="color: #7f7f7f;">Optionally set the following private ip as a public ip of your</span>
  <span style="color: #7f7f7f;"># </span><span style="color: #7f7f7f;">infrastructure</span>
  config.vm.network <span style="color: #a2cd5a;">:private_network</span>, <span style="color: #a2cd5a;">ip:</span> <span style="color: #deb887;">"192.168.121.245"</span>
  config.vm.synced_folder <span style="color: #deb887;">"./"</span>, <span style="color: #deb887;">"/vagrant"</span>, <span style="color: #a2cd5a;">type:</span> <span style="color: #deb887;">"rsync"</span>

  config.vm.provider <span style="color: #a2cd5a;">:virtualbox</span> <span style="color: #00bfff;">do</span> |vb|
    <span style="color: #7f7f7f;"># </span><span style="color: #7f7f7f;">vb.memory = "8192"  # Minimum</span>
    vb.memory = <span style="color: #deb887;">"16384"</span>   <span style="color: #7f7f7f;"># </span><span style="color: #7f7f7f;">Much better</span>
    vb.cpus = 4
    vb.gui = <span style="color: #a2cd5a;">false</span>
  <span style="color: #00bfff;">end</span>

  config.vm.provider <span style="color: #a2cd5a;">:libvirt</span> <span style="color: #00bfff;">do</span> |lv|
    <span style="color: #7f7f7f;"># </span><span style="color: #7f7f7f;">lv.memory = "8192"  # Minimum</span>
    lv.memory = <span style="color: #deb887;">"16384"</span>   <span style="color: #7f7f7f;"># </span><span style="color: #7f7f7f;">Much better</span>
    lv.cpus = 4
    lv.nested = <span style="color: #a2cd5a;">true</span>
    lv.cpu_mode = <span style="color: #deb887;">"host-passthrough"</span>
  <span style="color: #00bfff;">end</span>
<span style="color: #00bfff;">end</span>
</pre>
</div>

<p>
Then start and connect to the lab machine with the following commands.
</p>
<pre class="example">
vagrant up --provider=libvirt  # remove `--provider=libvirt` if you don't support vagrant-libvirt
vagrant ssh

</pre>

<p>
You can also synchronize the content of your current directory with
the content of the <code>/vagrant</code> directory in the lab machine with the
<code>vagrant rsync</code> command.
</p>
</div>
</div>

<div id="outline-container-orge2f6211" class="outline-3">
<h3 id="orge2f6211"><span class="section-number-3">4.2</span> Install MariaDB on Debian 10</h3>
<div class="outline-text-3" id="text-4-2">
<div class="org-src-container">
<pre class="src src-bash"><span style="color: #7f7f7f;">#</span><span style="color: #7f7f7f;">!/usr/bin/</span><span style="color: #00bfff;">env</span><span style="color: #7f7f7f;"> bash</span>
<span style="color: #7f7f7f;">#</span>
<span style="color: #7f7f7f;"># </span><span style="color: #7f7f7f;">Install and configure MariaDB for Debian 10.</span>

<span style="color: #7f7f7f;"># </span><span style="color: #7f7f7f;">Fix DNS resolution</span>
<span style="color: #f08080;">echo</span> <span style="color: #deb887;">""</span> &gt; /etc/resolv.conf
<span style="color: #f08080;">echo</span> <span style="color: #deb887;">"nameserver 8.8.8.8"</span> &gt;&gt; /etc/resolv.conf

<span style="color: #7f7f7f;"># </span><span style="color: #7f7f7f;">Parameters</span>
<span style="color: #4eee94;">DB_ROOTPASSWORD</span>=root
<span style="color: #4eee94;">DB_NAME</span>=wordpress    <span style="color: #7f7f7f;"># </span><span style="color: #7f7f7f;">Wordpress DB name</span>
<span style="color: #4eee94;">DB_USER</span>=silr         <span style="color: #7f7f7f;"># </span><span style="color: #7f7f7f;">Wordpress DB user</span>
<span style="color: #4eee94;">DB_PASSWORD</span>=silr     <span style="color: #7f7f7f;"># </span><span style="color: #7f7f7f;">Wordpress DB pass</span>

<span style="color: #7f7f7f;"># </span><span style="color: #7f7f7f;">Install MariaDB</span>
apt update -q
apt install -q -y mariadb-server mariadb-client

<span style="color: #7f7f7f;"># </span><span style="color: #7f7f7f;">Next line stops mysql install from popping up request for root password</span>
<span style="color: #f08080;">export</span> <span style="color: #4eee94;">DEBIAN_FRONTEND</span>=noninteractive
sed -i <span style="color: #deb887;">'s/127.0.0.1/0.0.0.0/'</span> /etc/mysql/mariadb.conf.d/50-server.cnf
systemctl restart mysql

<span style="color: #7f7f7f;"># </span><span style="color: #7f7f7f;">Setup MySQL root password and create a user and add remote privs to app subnet</span>
mysqladmin -u root password ${<span style="color: #4eee94;">DB_ROOTPASSWORD</span>}

<span style="color: #7f7f7f;"># </span><span style="color: #7f7f7f;">Create the wordpress database</span>
cat &lt;&lt; EOSQL | mysql -u root --password=${<span style="color: #4eee94;">DB_ROOTPASSWORD</span>}
<span style="color: #ffff00; font-weight: bold;">FLUSH PRIVILEGES;</span>
<span style="color: #ffff00; font-weight: bold;">CREATE USER '${DB_USER}'@'localhost';</span>
<span style="color: #ffff00; font-weight: bold;">CREATE DATABASE ${DB_NAME};</span>
<span style="color: #ffff00; font-weight: bold;">SET PASSWORD FOR '${DB_USER}'@'localhost'=PASSWORD("${DB_PASSWORD}");</span>
<span style="color: #ffff00; font-weight: bold;">GRANT ALL PRIVILEGES ON ${DB_NAME}.* TO '${DB_USER}'@'localhost' IDENTIFIED BY '${DB_PASSWORD}';</span>
<span style="color: #ffff00; font-weight: bold;">CREATE USER '${DB_USER}'@'%';</span>
<span style="color: #ffff00; font-weight: bold;">SET PASSWORD FOR '${DB_USER}'@'%'=PASSWORD("${DB_PASSWORD}");</span>
<span style="color: #ffff00; font-weight: bold;">GRANT ALL PRIVILEGES ON ${DB_NAME}.* TO '${DB_USER}'@'%' IDENTIFIED BY '${DB_PASSWORD}';</span>
<span style="color: #ffff00; font-weight: bold;">EOSQL</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org64633b9" class="outline-3">
<h3 id="org64633b9"><span class="section-number-3">4.3</span> Install Wordpress application on Debian 10</h3>
<div class="outline-text-3" id="text-4-3">
<div class="org-src-container">
<pre class="src src-bash"><span style="color: #7f7f7f;">#</span><span style="color: #7f7f7f;">!/usr/bin/</span><span style="color: #00bfff;">env</span><span style="color: #7f7f7f;"> bash</span>
<span style="color: #7f7f7f;">#</span>
<span style="color: #7f7f7f;"># </span><span style="color: #7f7f7f;">Install and configure Apache to serve Wordpress for Debian 10.</span>

<span style="color: #7f7f7f;"># </span><span style="color: #7f7f7f;">Fix DNS resolution</span>
<span style="color: #f08080;">echo</span> <span style="color: #deb887;">""</span> &gt; /etc/resolv.conf
<span style="color: #f08080;">echo</span> <span style="color: #deb887;">"nameserver 8.8.8.8"</span> &gt;&gt; /etc/resolv.conf

<span style="color: #7f7f7f;"># </span><span style="color: #7f7f7f;">Parameters</span>
<span style="color: #4eee94;">DB_NAME</span>=wordpress
<span style="color: #4eee94;">DB_USER</span>=silr
<span style="color: #4eee94;">DB_PASSWORD</span>=silr
<span style="color: #4eee94;">DB_HOST</span>=TODO

apt-get update -y
apt-get upgrade -y
apt-get install -q -y --force-yes wordpress apache2 curl lynx

cat &lt;&lt; EOF &gt; /etc/apache2/sites-available/wp.conf
<span style="color: #ffff00; font-weight: bold;">Alias /wp/wp-content /var/lib/wordpress/wp-content</span>
<span style="color: #ffff00; font-weight: bold;">Alias /wp /usr/share/wordpress</span>
<span style="color: #ffff00; font-weight: bold;">&lt;Directory /usr/share/wordpress&gt;</span>
<span style="color: #ffff00; font-weight: bold;">    Options FollowSymLinks</span>
<span style="color: #ffff00; font-weight: bold;">    AllowOverride Limit Options FileInfo</span>
<span style="color: #ffff00; font-weight: bold;">    DirectoryIndex index.php</span>
<span style="color: #ffff00; font-weight: bold;">    Require all granted</span>
<span style="color: #ffff00; font-weight: bold;">&lt;/Directory&gt;</span>
<span style="color: #ffff00; font-weight: bold;">&lt;Directory /var/lib/wordpress/wp-content&gt;</span>
<span style="color: #ffff00; font-weight: bold;">    Options FollowSymLinks</span>
<span style="color: #ffff00; font-weight: bold;">    Require all granted</span>
<span style="color: #ffff00; font-weight: bold;">&lt;/Directory&gt;</span>
<span style="color: #ffff00; font-weight: bold;">EOF</span>

a2ensite wp
service apache2 reload

cat &lt;&lt; EOF &gt; /etc/wordpress/config-default.php
<span style="color: #ffff00; font-weight: bold;">&lt;?php</span>
<span style="color: #ffff00; font-weight: bold;">define('DB_NAME', '${DB_NAME}');</span>
<span style="color: #ffff00; font-weight: bold;">define('DB_USER', '${DB_USER}');</span>
<span style="color: #ffff00; font-weight: bold;">define('DB_PASSWORD', '${DB_PASSWORD}');</span>
<span style="color: #ffff00; font-weight: bold;">define('DB_HOST', '${DB_HOST}');</span>
<span style="color: #ffff00; font-weight: bold;">define('WP_CONTENT_DIR', '/var/lib/wordpress/wp-content');</span>
<span style="color: #ffff00; font-weight: bold;">?&gt;</span>
<span style="color: #ffff00; font-weight: bold;">EOF</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org1d4c167" class="outline-3">
<h3 id="org1d4c167"><span class="section-number-3">4.4</span> VM Live migration</h3>
<div class="outline-text-3" id="text-4-4">
<p>
First start a VM with mpv and libcaca to output videos in the
terminal.  Download a video from youtube, so you can then broadcast it
on a loop with <code>mpv --vo caca --no-audio --loop vid.mp4</code> after SSH on it.
</p>
<div class="org-src-container">
<pre class="src src-bash">openstack server create migrate-vm <span style="color: #deb887;">\</span>
          --wait --flavor m1.mini --network private <span style="color: #deb887;">\</span>
          --image debian-10 <span style="color: #deb887;">\</span>
          --key-name ronana <span style="color: #deb887;">\</span>
          --user-data ./rsc/live-migrate-do-it.sh
<span style="color: #4eee94;">ALLOCATED_FIP</span>=$(<span style="color: #fa8072;">openstack</span> floating ip create -c floating_ip_address -f value external)
openstack server add floating ip migrate-vm <span style="color: #deb887;">"${ALLOCATED_FIP}"</span>
<span style="color: #f08080;">echo</span> <span style="color: #deb887;">"${ALLOCATED_FIP}"</span>
</pre>
</div>

<p>
Here is the script to setup the VM.
</p>
<div class="org-src-container">
<pre class="src src-bash"><span style="color: #7f7f7f;">#</span><span style="color: #7f7f7f;">!/usr/bin/</span><span style="color: #00bfff;">env</span><span style="color: #7f7f7f;"> bash</span>
apt update; apt install -y python3-pip mpv libcaca-dev
pip3 install --upgrade youtube_dl
<span style="color: #7f7f7f;"># </span><span style="color: #7f7f7f;">Pick a video under creative commons</span>
youtube-dl --recode-video mp4 --verbose <span style="color: #deb887;">\</span>
           --user-agent <span style="color: #deb887;">"Mozilla/5.0 (compatible; Googlebot/2.1; +http://www.google.com/bot.html)"</span> <span style="color: #deb887;">\</span>
           --output vid.mp4 <span style="color: #deb887;">\</span>
           <span style="color: #deb887;">"https://www.youtube.com/watch?v=ZXsQAXx_ao0"</span>
</pre>
</div>

<p>
Then while broadcasting, live migrate your VM and also take a look at
its state.
</p>
<div class="org-src-container">
<pre class="src src-bash">watch openstack server show migrate-vm -c <span style="color: #deb887;">'OS-EXT-SRV-ATTR:host'</span> -c <span style="color: #deb887;">'OS-EXT-STS:task_state'</span>
openstack server migrate migrate-vm --live-migration --block-migration
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Ronan-Alexandre Cherrueau, Adrien Lebre, Marie Delavergne, Didier Iscovery</p>
<p class="email">Email: <a href="mailto:{firstname.lastname}@inria.fr">{firstname.lastname}@inria.fr</a></p>
<p class="github">Find a typo, wanna make a proposition:
 <a href="https://github.com/BeyondTheClouds/lectures/issues/new?title=[os-polytech-laroche]">open an issue</a></p>
<p class="date">Last modification: 2021-12-17 ven. 09:02</p>
<p class="license">This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.</p>
<p class="creator"><a href="https://www.gnu.org/software/emacs/">Emacs</a> 26.3 (<a href="https://orgmode.org">Org</a> mode 9.1.9) ‚Äì <a href="http://gongzhitaao.org/orgcss">Zhitao Gong</a> customized theme</p>
</div>
</body>
</html>
